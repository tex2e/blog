---
layout:        post
title:         "é›¢æ•£å¯¾æ•°å•é¡Œã«å¯¾ã™ã‚‹æ”»æ’ƒæ‰‹æ³• (Python & SageMath)"
menutitle:     "é›¢æ•£å¯¾æ•°å•é¡Œã«å¯¾ã™ã‚‹æ”»æ’ƒæ‰‹æ³• (Adv.Cal. 2020)"
date:          2020-12-09
category:      Crypto
cover:         /assets/cover4.jpg
redirect_from:
comments:      true
published:     true
latex:         true
photoswipe:    false
# sitemap: false
# feed:    false
---

é›¢æ•£å¯¾æ•°å•é¡Œ (**DLP**) ã¸ã®æ”»æ’ƒæ‰‹æ³•ã¨ Python & SageMath ã«ã‚ˆã‚‹å®Ÿè£…ã®ã¾ã¨ã‚ã§ã™ã€‚
æš—å·æŠ€è¡“ã¨ã—ã¦ã€Diffie-Hellmanéµå…±æœ‰ãªã©ã®å®‰å…¨æ€§ã¯ã€Œé›¢æ•£å¯¾æ•°å•é¡Œã€ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚
ä»Šå¹´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ£ãƒ³ãƒ—2020ã®æš—å·è§£èª­ã‚¼ãƒŸã§ã¯ã€é›¢æ•£å¯¾æ•°å•é¡Œã‚’ãƒ†ãƒ¼ãƒã«ã—ã¦ã„ã‚‹æ–¹ãŒã„ãŸã®ã§ã€è©±ã«ã¤ã„ã¦ã„ããŸã‚ã«ç‹¬å­¦ã§å‹‰å¼·ã—ãŸã¨ãã®ã¾ã¨ã‚ã§ã™ã€‚
ãªãŠã€æ¥•å††æ›²ç·šä¸Šã®é›¢æ•£å¯¾æ•°å•é¡Œã«ã¤ã„ã¦å‹‰å¼·ã—ãŸã¨ãã®ã¾ã¨ã‚ã¯[æ¬¡ã®è¨˜äº‹](./ECDLP)ã§èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚


## é›¢æ•£å¯¾æ•°å•é¡Œ (DLP)

æœ‰é™ä½“ $F_p$ ã«ã¤ã„ã¦ã€ç´ æ•° $p$ ã¨ç”Ÿæˆå…ƒ $g$ã€$$y \in \{1, ..., p-1\}$$ ãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã€$y = g^x$ ã‚’æº€ãŸã™ $x$ ã‚’æ¢ã™ã“ã¨ã‚’é›¢æ•£å¯¾æ•°å•é¡Œã¨ã„ã„ã¾ã™ã€‚
è‹±èªã§ã¯ DLP (Discrete Logarithm Problem) ã¨è¨€ã£ãŸã‚Šã€æœ‰é™ä½“ä¸Šã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã« FFDLP (Finite Field DLP) ã¨æ›¸ã„ãŸã‚Šã—ã¾ã™ã€‚


ã“ã“ã§ã¯æ¬¡ã®4ã¤ã®é›¢æ•£å¯¾æ•°å•é¡Œã¸ã®æ”»æ’ƒæ‰‹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

- Baby-step Giant-stepæ³•
- Pollard's rhoæ³• (ãƒãƒ©ãƒ¼ãƒ‰ãƒ»ãƒ­ãƒ¼)
- Pohligâ€“Hellmanæ³• (ãƒãƒ¼ãƒªãƒƒãƒ’ãƒ»ãƒ˜ãƒ«ãƒãƒ³)
- æŒ‡æ•°è¨ˆç®—æ³•

<br>

## Baby-step Giant-stepæ³•

é›¢æ•£å¯¾æ•°å•é¡Œ $y = g^x \mod{p}$ ã® $x$ ã‚’æ±‚ã‚ã‚‹æ–¹æ³•ã®1ã¤ã§ã‚ã‚‹ 
Baby-step Giant-stepæ³• (ãƒ™ã‚¤ãƒ“ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—ãƒ»ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚¹ãƒ†ãƒƒãƒ—; BSGS) ã¯æ•°ãˆä¸Šã’æ³•ã‚ˆã‚Šã‚‚å°‘ãªã„å›æ•°ã®æ¼”ç®—ã§ã§ãã¾ã™ãŒã€å¤šãã®æ ¼ç´é ˜åŸŸã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚

ã¾ãšã€$m = \lceil \sqrt{p - 1}\rceil$ ã¨ãŠãã€$x$ ã‚’ $m$ ã§å‰²ã£ãŸã¨ãã®å•† $q$ ã¨ä½™ã‚Š $r$ ã®å¼ã‚’ä½œã‚Šã¾ã™ã€‚

$$
x = qm + r \;\;\;(0 \le r < m)
$$

ã“ã® $q, r$ ã‚’BSGSã§æ±‚ã‚ã‚‹ã“ã¨ã§ã€é›¢æ•£å¯¾æ•°å•é¡Œã® $y = g^x$ ã‚’æº€ãŸã™æœ€å°ã® $x$ ã‚’æ±‚ã¾ã‚Šã¾ã™ã€‚
ã¾ãšã€æ¬¡ã®ã‚ˆã†ã«å¼å¤‰å½¢ã‚’ã—ã¾ã™ã€‚

$$
\begin{aligned}
y        &= g^x \\
y        &= g^{qm+r} \\
y g^{-r} &= (g^m)^q
\end{aligned}
$$

æ¬¡ã«ã€Baby-stepã®å‡¦ç†ã¨ã—ã¦ã€å·¦è¾ºã®è¨ˆç®—ã‚’äº‹å‰ã«ã—ã€é›†åˆ $B$ ã‚’æ±‚ã‚ã¾ã™ã€‚ãªãŠ $r$ ã¯ä½™ã‚Šãªã®ã§ $m$ æœªæº€ã®æ•´æ•°ã¨ãªã‚Šã¾ã™ã€‚

$$
B = \{ (y g^{-r}, r) \;\vert\; 0 \le r < m \}
$$

ã‚‚ã—ã€é›†åˆ $B$ ã®ä¸­ã« $(1,r)$ ãŒã‚ã‚Œã°ã€$yg^{-r} = 1$ ã‚ˆã‚Š $y = g^r$ ã§ $x = r$ ãªã®ã§é›¢æ•£å¯¾æ•°å•é¡ŒãŒè§£ã‹ã‚Œã¾ã™ã€‚
ãã‚Œä»¥å¤–ã®ã¨ãã¯ã€Giant-stepã®å‡¦ç†ã¨ã—ã¦ã€å³è¾ºã®è¨ˆç®—ã‚’ã—ã¾ã™ã€‚$q = 1,2,...,m-1$ ã«å¯¾ã—ã¦ $g^{qm}$ ãŒé›†åˆ$B$ã®ä¸­ã«å«ã¾ã‚Œã‚‹ã‹ã‚’èª¿ã¹ã€å«ã¾ã‚Œã‚‹ã¨ãã¯ $q$ ã¨ $B$ ã«ä¿å­˜ã—ãŸ $r$ ã‹ã‚‰ $x = qm + r$ ã§é›¢æ•£å¯¾æ•°å•é¡ŒãŒè§£ã‹ã‚Œã¾ã™ã€‚

å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆPython 3.8 ä»¥é™ï¼‰

```python
def babystep_giantstep(g, y, p):
    m = int((p-1)**0.5 + 0.5)
    # Baby step
    table = {}
    gr = 1  # g^r
    for r in range(m):
        table[gr] = r
        gr = (gr * g) % p
    # Giant step
    gm = pow(g, -m, p)  # gm = g^{-m}
    ygqm = y            # ygqm = y * g^{-qm}
    for q in range(m):
        if ygqm in table: # å³è¾ºã¨å·¦è¾ºãŒä¸€è‡´ã™ã‚‹ã¨ã
            return q * m + table[ygqm]
        ygqm = (ygqm * gm) % p
    return None

g = 7
y = 765686981
p = 35808104999
x = babystep_giantstep(g, y, p)
print(x)
print(pow(g, x, p) == y)
```

<br>

## Pollard's rhoæ³•

é›¢æ•£å¯¾æ•°å•é¡Œ $y = g^x \mod{p}$ ã® $x$ ã‚’æ±‚ã‚ã‚‹æ–¹æ³•ã®1ã¤ã§ã‚ã‚‹
Pollard's rhoæ³•ï¼ˆãƒãƒ©ãƒ¼ãƒ‰ãƒ»ãƒ­ãƒ¼ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã¯BSGSã¨åŒã˜è¨ˆç®—é‡ã§ã™ãŒã€ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¢ãƒªç©ºé–“ã¯å®šæ•°é‡ã®ã¿ã§ã™ã€‚
ãªã®ã§ã€BSGSã‚ˆã‚Šã‚‚å°‘ãªã„ãƒ¡ãƒ¢ãƒªç©ºé–“ã§é›¢æ•£å¯¾æ•°ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãšã€é–¢æ•° $f$ ã‚’æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ï¼ˆã“ã‚Œã¯ãƒ©ãƒ³ãƒ€ãƒ ã«ç§»å‹•ã™ã‚‹ãŸã‚ã®é–¢æ•°ã§ã™ï¼‰ã€‚

$$
f(x) =
  \begin{cases}
    yx  & (x \in G_1 ã®ã¨ã) \\
    x^2 & (x \in G_2 ã®ã¨ã) \\
    gx  & (x \in G_3 ã®ã¨ã)
  \end{cases}
$$

æ¬¡ã«ã€æ•°åˆ— $x_i$ ã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚ä¹±æ•° $a_0$ ã‚’é¸ã³ã€$x_0 = g^{a_0}$ ã¨ã—ã¾ã™ã€‚
ã“ã®ã¨ãã®æ•°åˆ— $x_i$ ã‚’æ¼¸åŒ–å¼ $x_{i+1} = f(x_i)$ ã§è¨ˆç®—ã™ã‚‹ã¨ã€
ã“ã®æ•°åˆ—ã®é …ã¯ $x_i = g^{a_0} y^{b_0}$ ã¨ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã€$b_0 = 0$ ã§ã€$a_{i+1}, b_{i+1}$ ã¯é–¢æ•° $f$ ã®å®šç¾©ã‹ã‚‰æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

$$
a_{i+1} =
  \begin{cases}
    a_i              & (x_i \in G_1 ã®ã¨ã) \\
    2a      \pmod{p} & (x_i \in G_2 ã®ã¨ã) \\
    a_i + 1 \pmod{p} & (x_i \in G_3 ã®ã¨ã)
  \end{cases}
$$

$$
b_{i+1} =
  \begin{cases}
    b_i + 1 \pmod{p} & (x_i \in G_1 ã®ã¨ã) \\
    2b      \pmod{p} & (x_i \in G_2 ã®ã¨ã) \\
    b_i              & (x_i \in G_3 ã®ã¨ã)
  \end{cases}
$$

ãƒãƒ©ãƒ¼ãƒ‰ãƒ»ãƒ­ãƒ¼ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã¯ã€$y = g^x$ ã‚’æ±‚ã‚ã‚‹ãŸã‚ã«ã€ã¾ãš $g^{a_i}y^{b_i} = g^{A_i}y^{B_i}$ ã‚’æº€ãŸã™ $(a_i, b_i), (A_i, B_i)$ ã‚’æ±‚ã‚ã¾ã™ã€‚$G$ ã¯ $g$ ãŒç”Ÿæˆã™ã‚‹å·¡å›ç¾¤ãªã®ã§ã€$x_{i+k} = x_i$ ã¨ãªã‚‹ $i, k$ ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€

$$
\begin{aligned}
g^{a_i}y^{b_i}    &\equiv g^{a_{i+k}}y^{b_{i+k}} \pmod{p} \\
g^{a_i - a_{i+k}} &\equiv y^{b_{i+k} - b_i}      \pmod{p} \\
g^{a_i - a_{i+k}} &\equiv g^{x(b_{i+k} - b_i)}   \pmod{p} \\
(a_i - a_{i+k})   &\equiv x(b_{i+k} - b_i)       \pmod{p-1} \\
\end{aligned}
$$

ãŒæˆç«‹ã—ã¾ã™ã€‚ã‚ˆã£ã¦ã€æ¬¡ã®å¼ã‹ã‚‰é›¢æ•£å¯¾æ•° $x$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$$
x \equiv (a_i - a_{i+k}) (b_{i+k} - b_i)^{-1}  \pmod{p-1}
$$

$g^{a_i}y^{b_i} = g^{A_i}y^{B_i} = g^{a_{i+k}}y^{b_{i+k}}$ ã‚’æº€ãŸã™ $(a_i, b_i), (a_{i+k}, b_{i+k})$ ã®æ¢ã—æ–¹ã¯ã€å·¡å›ç¾¤ã®æ•°åˆ— $x_i$ ã¯å‘¨æœŸçš„ã§ã‚ã‚‹ã®ã§ã€ãƒ•ãƒ­ã‚¤ãƒ‰ã®å¾ªç’°æ¤œå‡ºæ³•ï¼ˆã‚¦ã‚µã‚®ã¨ã‚«ãƒ¡ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã‚’ä½¿ã£ã¦æ±‚ã‚ã¾ã™ã€‚

å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆPython 3.8 ä»¥é™ï¼‰

```python
def pollard_rho(g, y, p):
    q = (p-1) // 2
    # ãƒ©ãƒ³ãƒ€ãƒ ã«ç§»å‹•ã™ã‚‹ãŸã‚ã®é–¢æ•°
    def new_xab(x, a, b,  g, y, p, q):
        subset = x % 3
        if subset == 0:
            return ((x*x) % p, (a*2) % q, (b*2) % q)
        if subset == 1:
            return ((x*g) % p, (a+1) % q, b        )
        if subset == 2:
            return ((x*y) % p, a        , (b+1) % q)
    # ãƒ•ãƒ­ã‚¤ãƒ‰ã®å¾ªç’°æ¤œå‡ºæ³•
    x, a, b = 1, 0, 0
    X, A, B = x, a, b
    for i in range(1, p):
        x, a, b = new_xab(x, a, b,  g, y, p, q)
        X, A, B = new_xab(X, A, B,  g, y, p, q)
        X, A, B = new_xab(X, A, B,  g, y, p, q)
        if x == X:
            break
    res = ((a - A) * pow(B - b, -1, q)) % q
    if pow(g, res, p) == y:
        return res
    if pow(g, res + q, p) == y:
        return res + q
    return None

g = 7
y = 765686981
p = 35808104999
x = pollard_rho(g, y, p)
print(x)
print(pow(g, x, p) == y)
```

<br>

## Pohligâ€“Hellmanæ³•

Pohligâ€“Hellmanæ³•ï¼ˆãƒãƒ¼ãƒªãƒƒãƒ’ãƒ»ãƒ˜ãƒ«ãƒãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã¯å·¡å›ç¾¤ $G$ ã®ä½æ•° $\lvert G\rvert$ ãŒ $p_1, p_2, ...$ ã«å› æ•°åˆ†è§£ã§ãã‚‹ã¨ãã€$G$ ã§ã®é›¢æ•£å¯¾æ•° $y = g^x \pmod{p}$ ã®è¨ˆç®—å•é¡Œã‚’ã€ç´ æ•°ä½æ•° $p_i$ ã§ã®é›¢æ•£å¯¾æ•°å•é¡Œã«å¸°ç€ã•ã›ã‚‹ã“ã¨ã§å•é¡Œã‚’å°ã•ãã—ã¦è§£ãã€å¾—ã‚‰ã‚ŒãŸè¤‡æ•°ã®çµæœã‹ã‚‰ã€æœ€å¾Œã«ä¸­å›½äººå‰°ä½™å®šç†ã§ç­”ãˆã‚’æ±‚ã‚ã‚‹æ–¹æ³•ã§ã™ã€‚

ã¾ãšã€$p-1$ ãŒç´ æ•° $q_i$ ã«ç´ å› æ•°åˆ†è§£ã§ãã‚‹ã¨ã—ã¾ã™ã€‚

$$
p-1 = q_1 q_2 \cdots q_k
$$

é›¢æ•£å¯¾æ•° $x$ ã¯ä»»æ„ã®è‡ªç„¶æ•°ãªã®ã§ã€å•† $b_i$ ã¨ä½™ã‚Š $a_i$ ã‚’ä½¿ã£ã¦ $x = a_i + b_i q_i$ ã¨æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
æ¬¡ã« $y = g^x \pmod{p}$ ã®ä¸¡è¾ºã‚’ $\frac{p-1}{q_i}$ ä¹—ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¼å¤‰å½¢ã§ãã¾ã™ã€‚
ãªãŠã€é€”ä¸­ã§ã‚ªã‚¤ãƒ©ãƒ¼ã®å®šç† $g^{p-1} \equiv g^{\varphi(p)} \equiv 1 \pmod{p}$ ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

$$
\begin{aligned}
y^{\frac{p-1}{q_i}} 
  &\equiv g^{x \,\frac{p-1}{q_i}} \pmod{p} \\
  &\equiv (g^{a_i + b_i q_i})^{\frac{p-1}{q_i}} \pmod{p} \\
  &\equiv g^{\frac{a_i (p-1)}{q_i}} g^{b_i (p - 1)} \pmod{p} \\
  &\equiv g^{\frac{a_i (p-1)}{q_i}} \pmod{p} \\
\end{aligned}
$$

è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€$y_i = y^{\frac{p-1}{q_i}},\; g_i = g^{\frac{p-1}{q_i}}$ ã¨ãŠãã¨ã€

$$
y_i \equiv g_i^{a_i} \pmod{p}
$$

ã¨ãªã‚Šã€æœ€åˆã«ç¤ºã—ãŸé›¢æ•£å¯¾æ•°å•é¡Œã®å½¢ã«ãªã‚Šã¾ã™ãŒã€ä½™ã‚Š $a_i$ ã¯å‰²ã‚‹æ•° $q_i$ ã‚ˆã‚Šã‚‚å°ã•ã„ã¨ã„ã†äº‹å®Ÿã‹ã‚‰ã€ã‚ˆã‚Šé«˜é€Ÿã«é›¢æ•£å¯¾æ•° $a_i$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã—ã¦ $(g_i)^{q_i} = (g^{\frac{p-1}{q_i}})^{q_i} = 1$ ã‚ˆã‚Š $g_i$ ã®ä½æ•°ã¯ $q_i$ ã§ã™ã€‚ã“ã“ã‹ã‚‰ã€å…¨ã¦ã®ç´ å› æ•°ã§ã®é›¢æ•£å¯¾æ•° $a_i$ ã‚’ã¾ã¨ã‚ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

$$
\begin{aligned}
  x &\equiv a_0 \pmod{q_0} \\
  x &\equiv a_1 \pmod{q_1} \\
    &\;\;\vdots \\
  x &\equiv a_k \pmod{q_k} \\
\end{aligned}
$$

$q_0, ..., q_k$ ã¯äº’ã„ã«ç´ ãªã®ã§ã€ä¸­å›½äººå‰°ä½™å®šç†(CRT)ã‚’ä½¿ã£ã¦ã€ã“ã‚Œã‚‰ã‚’æº€ãŸã™é›¢æ•£å¯¾æ•° $x$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆSageMath 9.0, Python 3.8 ä»¥é™ï¼‰

```python
# Baby-step Giant-stepæ³•
def babystep_giantstep(g, y, p, q=None):
    if q is None:
        q = p - 1
    m = int(q**0.5 + 0.5)
    # Baby step
    table = {}
    gr = 1  # g^r
    for r in range(m):
        table[gr] = r
        gr = (gr * g) % p
    # Giant step
    try:
        gm = pow(g, -m, p)  # gm = g^{-m}
    except:
        return None
    ygqm = y                # ygqm = y * g^{-qm}
    for q in range(m):
        if ygqm in table:   # å·¦è¾ºã¨å³è¾ºãŒä¸€è‡´ã™ã‚‹ã¨ã
            return q * m + table[ygqm]
        ygqm = (ygqm * gm) % p
    return None

# Pohligâ€“Hellmanæ³•
def pohlig_hellman_DLP(g, y, p):
    crt_moduli = []
    crt_remain = []
    for q, _ in factor(p-1):
        x = babystep_giantstep(pow(g,(p-1)//q,p), pow(y,(p-1)//q,p), p, q)
        if (x is None) or (x <= 1):
            continue
        crt_moduli.append(q)
        crt_remain.append(x)
    x = crt(crt_remain, crt_moduli)
    return x

g = 2
y = 1094511311619717224471473901707
p = 2 * 32803 * 196159 * 1981991353 * 47814426923 + 1  # ç´ æ•°p
x = pohlig_hellman_DLP(g, y, p)
print(x)
print(pow(g, x, p) == y)
```

<br>

## æŒ‡æ•°è¨ˆç®—æ³•

é›¢æ•£å¯¾æ•°å•é¡Œ $y = g^x \mod{p}$ ã® $x$ ã‚’æ±‚ã‚ã‚‹æ–¹æ³•ã®1ã¤ã§ã‚ã‚‹æŒ‡æ•°è¨ˆç®—æ³•ï¼ˆIndex Calculus Algorithmï¼‰ã¯ã€BSGSã‚„ãƒ­ãƒ¼æ³• ($\rho$æ³•) ã‚ˆã‚Šã‚‚åŠ¹ç‡ã®è‰¯ã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚

åˆåŒå¼ $y \equiv g^x \pmod{p}$ ã‚’è§£ããŸã‚ã«ã€ä¸€ã¤ã®ä¸Šç•Œ $B$ ã‚’æ±ºã‚ã¾ã™ã€‚ä»»æ„ã®æ•´æ•° $\beta$ ã®å…¨ã¦ã®ç´ å› æ•° $q \in \mathbb{P}$ ãŒ $B$ ä»¥ä¸‹ã®ã¨ãã€ã“ã®é›†åˆï¼ˆå› å­åŸºåº•ï¼‰ã¯ $$F(B) = \{ q \in \mathbb{P} \;\vert\; q \le B \}$$ ã¨æ›¸ãã€ã“ã®ã¨ãæ•´æ•° $\beta$ ã¯ $B$ ã‚¹ãƒ ãƒ¼ã‚ºï¼ˆ$B$-smoothï¼‰ã¨ã„ã„ã¾ã™ã€‚

ã¾ãšã€å› å­åŸºåº•ã®å…¨ã¦ã®å…ƒã«å¯¾ã—ã¦é›¢æ•£å¯¾æ•°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚ä¹±æ•° $$k \in \{1,...,p-1\}$$ ã‚’é¸ã³ã€$g^k \;\mathrm{mod}\;p$ ãŒ $B$ ã‚¹ãƒ ãƒ¼ã‚ºãªæ•°ã§ã‚ã‚‹ã‹ã‚’èª¿ã¹ã¾ã™ã€‚
$B$ ã‚¹ãƒ ãƒ¼ã‚ºãªæ•°ã§ã‚ã‚Œã°ã€ãã®ç´ å› æ•°åˆ†è§£ã‚’è¨ˆç®—ã—ã¾ã™ ($g^k \;\mathrm{mod}\; p = p_1^{e_1} p_2^{e_2} \cdots p_n^{e_n}$)ã€‚ã“ã‚ŒãŒååˆ†ãªæ•° $C$ å€‹ã®åˆåŒå¼ãŒé›†ã¾ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ã¨ã€æ¬¡ã®å¼ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

$$
\begin{aligned}
g^{k_1} &\equiv p_1^{e_{11}} p_2^{e_{21}} \cdots p_n^{e_{n1}} \pmod{p} \\
g^{k_2} &\equiv p_1^{e_{12}} p_2^{e_{22}} \cdots p_n^{e_{n2}} \pmod{p} \\
  &\;\;\vdots \\
g^{k_C} &\equiv p_1^{e_{1C}} p_2^{e_{2C}} \cdots p_n^{e_{nC}} \pmod{p} \\
\end{aligned}
$$

ã“ã‚Œã‚‰ã®åˆåŒå¼ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¼å¤‰å½¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ ($p_i^{e_{ij}} = (g^{\log_g p_i})^{e_{ij}}$ ã¨ã€å·¡å›ç¾¤ã®ä½æ•°ã¯ $p-1$ ãªã®ã§)ã€‚

$$
\begin{aligned}
k_1 &\equiv e_{11} \log_g p_1 + e_{21} \log_g p_2 + \cdots + e_{n1} \log_g p_n \pmod{p-1} \\
k_2 &\equiv e_{12} \log_g p_1 + e_{22} \log_g p_2 + \cdots + e_{n2} \log_g p_n \pmod{p-1} \\
  &\;\;\vdots \\
k_C &\equiv e_{13} \log_g p_1 + e_{2C} \log_g p_2 + \cdots + e_{nC} \log_g p_n \pmod{p-1} \\
\end{aligned}
$$

æ¬¡ã®ç›®æ¨™ã¯é›¢æ•£å¯¾æ•° $\log_g p_i$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®å€¤ã¯ã™ã¹ã¦ã®åˆåŒå¼ã®å„é …ã§å…±é€šãªã®ã§ã€è¡Œåˆ—ã®æ›ã‘ç®—ã®å½¢ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$$
\begin{pmatrix}
k_1 \\ k_2 \\ \vdots \\ k_C
\end{pmatrix}
= \begin{pmatrix}
e_{11} & e_{21} & \ldots & e_{n1} \\
e_{12} & e_{22} & \ldots & e_{n2} \\
\vdots & \vdots & \ddots & \vdots \\
e_{1C} & e_{2C} & \ldots & e_{nC}
\end{pmatrix}
\begin{pmatrix}
\log_g p_1 \\ \log_g p_2 \\ \vdots \\ \log_g p_n
\end{pmatrix}
\pmod{p-1}
$$

è¡Œåˆ—ã®å½¢ã«ã—ãŸã“ã¨ã§ã€ã‚¬ã‚¦ã‚¹ã®æ¶ˆå»æ³•ã«ã‚ˆã‚Šã€$(\log_g p_i)$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã“ã¾ã§ã®äº‹å‰è¨ˆç®—ãŒçµ‚ã‚ã£ãŸã‚‰ã€æœ€å¾Œã«ã€æ±‚ã‚ã‚‹é›¢æ•£å¯¾æ•° $x = \log_g y$ ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
ã¾ãšã€ä¹±æ•° $$\kappa \in \{1,...,p-1\}$$ ã‚’é¸ã³ã€ä»¥ä¸‹ã®å¼ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

$$
y g^\kappa \;\mathrm{mod}\;p
$$

ã“ã®å€¤ãŒ $B$ ã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚‹ã¾ã§ä¹±æ•°ã‚’é¸ã³ãªãŠã—ã¾ã™ã€‚
ã‚‚ã— $B$ ã‚¹ãƒ ãƒ¼ã‚ºã§ã‚ã‚Œã°å› æ•°åˆ†è§£ã—ã¾ã™ã€‚

$$
y g^\kappa \equiv p_1^{c_1} p_2^{c_2} \cdots p_n^{c_n} \pmod{p}
$$

ã“ã®åˆåŒå¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¼å¤‰å½¢ã§ãã¾ã™ã€‚

$$
\log_g y + \kappa \equiv c_1 \log_g p_1 + c_2 \log_g p_2 + \cdots + c_n \log_g p_n \pmod{p-1}
$$

ã“ã“ã§ $\log_g y$ ä»¥å¤–ã¯å…¨ã¦ã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€é›¢æ•£å¯¾æ•° $\log_g y = x$ ã¯ä»¥ä¸‹ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$$
x = \left( \sum_{i} c_i \log_g p_i - \kappa\right) \;\mathrm{mod}\;(p-1)
$$

å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆSageMath 9.0, Python 3.8ï¼‰

```python
# nãŒBã‚¹ãƒ ãƒ¼ã‚ºãªæ•°ã§ã‚ã‚‹ã‹ã‚’èª¿ã¹ã‚‹
def is_Bsmooth(b, n):
    factors = list(factor(int(n)))
    if len(factors) != 0 and factors[-1][0] <= b: 
        return True, dict(factors)
    else:
        return False, dict(factors)

# é€£ç«‹åˆåŒå¼ã‚’æ±‚ã‚ã‚‹
def find_congruences(B, g, p, congruences=[]):
    unique = lambda l: list(set(l))
    bases = []
    max_equations = prime_pi(B)
    while True:
        k = randint(2, p-1)
        ok, factors = is_Bsmooth(B, pow(g,k,p))
        if ok:
            # TODO: ç·šå½¢ç‹¬ç«‹ã®ã¨ãã ã‘è¿½åŠ ã™ã‚‹
            congruences.append((factors, k))
            if len(congruences) >= max_equations:
                break
    bases = unique([base for c in [c[0].keys() for c in congruences] for base in c])
    return bases, congruences

# é€£ç«‹åˆåŒå¼ã‚’è¡Œåˆ—ã«å¤‰æ›ã™ã‚‹
def to_matrices(R, bases, congruences):
    M = [[c[0][base] if base in c[0] else 0 \
            for base in bases] for c in congruences]
    b = [c[1] for c in congruences]
    return Matrix(R, M), vector(R, b)

# æŒ‡æ•°è¨ˆç®—æ³•
def index_calculus(g, y, p, B=None):
    R = IntegerModRing(p-1)
    if B is None:
        B = ceil(exp(0.5*sqrt(2*log(p)*log(log(p)))))
    bases = []
    congruences = []
    # åˆåŒå¼ã‚’æº€ãŸã™è¡Œåˆ—ãŒã§ãã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ã€‚
    for i in range(100):
        bases, congruences = find_congruences(B, g, p, congruences)
        M, b = to_matrices(R, bases, congruences)
        # Mx = b ã‚’æº€ãŸã™è¡Œåˆ—xã‚’æ±‚ã‚ã‚‹
        try:
            exponents = M.solve_right(b)
            break
        except ValueError:
            # matrix equation has no solutions
            continue
    else:
        return None
    # ag^y mod p ãŒBã‚¹ãƒ ãƒ¼ã‚ºã§ã‚ã‚‹æŒ‡æ•°kã‚’æ±ºå®šã™ã‚‹
    while True:
        k = randint(2, p-1)
        ok, factors = is_Bsmooth(B, (y * pow(g,k,p)) % p)
        if ok and set(factors.keys()).issubset(bases):
            print('found k = {}'.format(k))
            break
    print('bases:', bases)
    print('q:', factors.keys())
    dlogs = {b: exp for (b,exp) in zip(bases, exponents)}
    x = (sum(dlogs[q] * e for q, e in factors.items()) - k) % (p-1)
    if pow(g, x, p) == y:
        return x
    return None

g = 2
y = 330456869054588
p = 924614919573299
x = index_calculus(g, y, p)
print(x)
print(pow(g, x, p) == y)
```


<br>

## æ•°ä½“ãµã‚‹ã„æ³•

æŒ‡æ•°è¨ˆç®—æ³•ã‚’æ”¹è‰¯ã—ãŸã‚‚ã®ã«ã€Œæ•°ä½“ãµã‚‹ã„æ³•ã€ãŒã‚ã‚Šã¾ã™ã€‚
ã„ã‚ã„ã‚è«–æ–‡ã‚’è¦‹ãªãŒã‚‰ç‰¹æ®Šæ•°ä½“ãµã‚‹ã„æ³•ã®å®Ÿè£…ã‚’è©¦ã¿ãŸã®ã§ã™ãŒã€ç‰¹å®šã®å€¤ã®ã¨ãã—ã‹é›¢æ•£å¯¾æ•°å•é¡Œã‚’è§£ãã“ã¨ãŒã§ããªã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã§ãã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ä¸€å¿œã€æ•°ä½“ãµã‚‹ã„æ³•ã®Pythonå®Ÿè£…ã¯æ¤œç´¢ã—ã¦ã‚‚ã‚ã¾ã‚Šãªã„ã®ã§ã€èª°ã‹ã®å½¹ã«ç«‹ã¦ã°ã„ã„ãªã¨æ€ã„ã€æ®‹éª¸ã‚’Gistã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ã€€[\[WIP\] Special Number Field Sieve (SageMath) -- Gist](https://gist.github.com/tex2e/7ce03332556c63887b68c489173ec023)

æ•°ä½“ãµã‚‹ã„æ³•ã§å‚è€ƒã«ã—ãŸè«–æ–‡ï¼š

- [Worked Example for the Special Number Field Sieve](https://jbootle.github.io/Misc/snfs.pdf) ... è¨ˆç®—é€”ä¸­ã®å€¤ãŒã‚ã‚‹ã®ã§å®Ÿè£…æ™‚ã®ãƒ†ã‚¹ãƒˆã«ä½¿ãˆã¾ã™
- [An Introduction to the General Number Field Sieve](https://intranet.math.vt.edu/people/brown/doc/briggs_gnfs_thesis.pdf) ... 5.5 Sieving ã‚„ 5.6 Forming the Matrix ã®è¡Œåˆ—ã®ä½œã‚Šæ–¹ãªã©ãŒå‚è€ƒã«ãªã‚Šã¾ã™
- [é›¢æ•£å¯¾æ•°å•é¡Œã®å›°é›£æ€§ã«é–¢ã™ã‚‹è¨ˆç®—é‡ã«ã¤ã„ã¦ã®èª¿æŸ»ãƒ»ç ”ç©¶å ±å‘Šæ›¸ (CRYPTOREC)](https://www.cryptrec.go.jp/exreport/cryptrec-ex-0602-2006.pdf) ... 2.2 æœ‰é™ä½“ä¸Šã®é›¢æ•£å¯¾æ•°å•é¡Œã¸ã®NFS ã¨ã‹ãŒå‚è€ƒã«ãªã‚‹ (æ•°å°‘ãªã„æ—¥æœ¬èªã§ã®è§£èª¬)
- [smallnfs/smallnfs.sage at master Â· lgremy/smallnfs](https://github.com/lgremy/smallnfs/blob/master/src/smallnfs.sage) ... æ•°ä½“ãµã‚‹ã„æ³•ã®SageMathã«ã‚ˆã‚‹å®Ÿè£…ã‚‰ã—ãã‚‚ã®ã€‚æ­£ã—ãå‹•ä½œã™ã‚‹ã‹æœªç¢ºèª


ä»¥ä¸Šã§ã™ã€‚

ğŸ„ã“ã®è¨˜äº‹ã¯ [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ£ãƒ³ãƒ— Advent Calendar 2020 - Adventar](https://adventar.org/calendars/5325) ã®9æ—¥ç›®ã§ã™ã€‚æ˜æ—¥ã¯ TumoiYorozu ã•ã‚“ã§ã€Œã‚­ãƒ£ãƒ³ãƒ—ã®è¬›ç¾©ã®è¨˜äº‹ã€ã§ã™ã€‚ãŠæ¥½ã—ã¿ã«ğŸ„


### å‚è€ƒæ–‡çŒ®

- J.A.ãƒ–ãƒ¼ãƒ•ãƒãƒ³ è‘—ã€æ— èŠ³æ¨¹ è¨³ã€æš—å·ç†è«–å…¥é–€ åŸæ›¸ç¬¬3ç‰ˆã€ä¸¸å–„å‡ºç‰ˆ 2012
- Douglas R. Stinson è‘—ã€æ«»äº•å¹¸ä¸€ ç›£è¨³ã€æš—å·ç†è«–ã®åŸºç¤ã€å…±ç«‹å‡ºç‰ˆ 1994
- [ä»£æ•°æ›²ç·šæš—å·ã¨ãã®å®‰å…¨æ€§ - ç¬¬ 15 å› æ•´æ•°è«–ã‚µãƒãƒ¼ã‚¹ã‚¯ãƒ¼ãƒ« å ±å‘Šé›†, pp.223-238](http://www2.meijo-u.ac.jp/~yonishi/research/pub/ss2007/11matsuo.pdf)
